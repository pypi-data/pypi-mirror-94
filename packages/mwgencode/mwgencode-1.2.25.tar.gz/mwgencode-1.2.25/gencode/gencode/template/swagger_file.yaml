swagger: "2.0"
info:
  description: "{{ (swg.desc or '').replace('\"','\'') }}"

  version: v1.0
  title: {{ swg.name }}
#{{swg.host}}
basePath: /{{ swg.name }}/v1.0
{% if swg.tags %}
tags:
{% for tag in swg.tags %}
- name: {{ tag.name }}
  description: "{{ (tag.doc or '').replace('\"','\'') }}"
{% endfor %}
{% endif %}
schemes:
- http
- https

{% if swg.auth=='jwt'%}
securityDefinitions:
  api_jwt:
    type: apiKey
    name: jwt
    in: query
  api_key:
    type: apiKey
    name: apikey
    in: query
{% endif %}
paths:
{% for path in paths %}
  /{{ path.name.replace('_{','/{').replace('}_','}/') }}:
  {% for act in path.actions %}
    {{ act.action }}:
      tags:
      - {{ path.tag.name }}
      summary: "{{ (act.summary or '').replace('\"','\'') }}"
      description: "{{ (act.doc or '').replace('\"','\'') }}"
      operationId: app.api.{{ act.ver_str }}.{{ path.tag.name }}.{{ path.name.replace('/','_').replace('{','').replace('}','').replace('-','_') }}_{{ act.action }}
      schemes:
        - http
        - https
      consumes:
        - application/json
          {% if swg.resp_xml %}
        - application/xml
          {% endif %}
          {% if swg.resp_html %}
        - text/html
          {% endif %}
          {% if act.has_formdata %}
        - application/x-www-form-urlencoded
        - multipart/form-data
          {% endif %}

      produces:
        - application/json
          {% if swg.resp_xml %}
        - application/xml
          {% endif %}
          {% if swg.resp_html %}
        - text/html
          {% endif %}

    {% if act.params %}
      parameters:
      {% for param in act.params %}
        - in: {{ param.in_ }}
          name: {{ param.name }}
          description: "{{ (param.desc or '').replace('\"','\'') }}"
          required: {{ param.required }}
          {% if param.is_array %}
              {% if param.type_attr == "data" %}
          type: array
          items:
            type: {{ param.type }}
                     {% if param.format %}
            format: {{ param.format }}
                     {% endif %}
          collectionFormat: multi
              {% elif param.type_attr == "object" %}
          schema:
            type: array
            items:
              $ref: "#/definitions/{{ param.ref_name }}"
              {% endif %}
          {% else %}
             {% if param.type_attr == "data" %}
          type: {{ param.type }}
                 {% if param.format %}
          format: {{ param.format }}
                 {% endif %}
             {% elif param.type_attr == "object" %}
          schema:
            $ref: "#/definitions/{{ param.ref_name }}"
             {% endif %}
          {% endif %}
      {% endfor %}
    {% endif %}
      responses:
    {% for resp in act.resps %}
        {{ resp.code }}:
          description: "{{ (resp.desc or '').replace('\"','\'') }}"
        {% if resp.type_attr != "none" %}
          {% if resp.is_array %}
          schema:
            type: "array"
            items:
            {% if resp.type_attr=="object" %}
              $ref: "#/definitions/{{ resp.ref_name }}"
            {% elif resp.type_attr=="data" %}
              type : {{ resp.type }}
            {% endif %}
          {% else %}
          schema:
            {% if resp.type_attr=="object" %}
            $ref: "#/definitions/{{ resp.ref_name }}"
            {% elif resp.type_attr=="data" %}
            type: string
            {% endif %}
          {% endif %}
        {% endif %}
    {% endfor %}
    {% if swg.auth=='jwt' and act.is_auth %}
      security:
         - api_key: []
         - api_jwt: []
    {% endif %}
  {% endfor %}
{% endfor %}
{% if swg.defines %}
definitions:
{% endif %}
{% for defin in swg.defines %}
  {{ defin.name }}:
    type: object
    description: "{{ (defin.desc or '').replace('\"','\'') }}"
    properties:
    {% for attr in defin.attrs %}
      {{ attr.name }}:
        {% if attr.is_array %}
        description: "{{ (attr.desc or '').replace('\"','\'') }}"
        type: array
        items:
            {% if attr.type_attr=="object" %}
          $ref: "#/definitions/{{ attr.ref_name }}"
            {% elif attr.type_attr=="data" %}
          type: {{ attr.type }}
              {% if attr.format %}
          format: {{ attr.format }}
              {% endif %}
            {% endif %}
        {% else %}
            {% if attr.type_attr=="object" %}
        $ref: "#/definitions/{{ attr.ref_name }}"
            {% elif attr.type_attr=="data" %}
        description: "{{ (attr.desc or '').replace('\"','\'') }}"
        type: {{ attr.type }}
              {% if attr.format %}
        format: {{ attr.format }}
              {% endif %}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endfor %}

