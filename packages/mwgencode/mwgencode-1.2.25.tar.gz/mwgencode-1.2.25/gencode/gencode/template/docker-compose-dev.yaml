version: '2'
services:
  {{ swagger.name }}:
#    image: cxhjet/flask-py3.6:1.8
    build: .
    # image名稱，被docker registrator作為服務名註冊
    image: {{swagger.name}}:1.0.0
    container_name: {{swagger.name}}_python3.6
    restart: always
    network_mode: bridge
    environment:
      #  python程序通過這個變量找到consul
      CONSUL_HTTP_ADDR: ${CONSUL_HTTP_ADDR} #192.168.101.88:8500
      WEB_PORT : ${WEB_PORT} #8001
      DATABASE_NAME : ${DATABASE_NAME} #maxbus
      #  系统权限名称
      SYSTEM_NAME : ${SYSTEM_NAME}
      # 第一層權限的ID
      SYSTEM_ID : ${SYSTEM_ID}
      # true自動註冊到kong，false 不會註冊
      # 注意：值為true時，需要ports中設定的內外IP設為相等
      KONG_AUTO_REGISTER: ${KONG_AUTO_REGISTER}
      CONSUL_AUTO_REGISTER: ${CONSUL_AUTO_REGISTER}
      LOG_LEVEL: ${LOG_LEVEL}
      UPLOAD_FOLDER: ${UPLOAD_FOLDER}
      SWAGGER_HOST: ${SWAGGER_HOST}
      #AUTH_TYPE: ${AUTH_TYPE}
      SERVICE_IGNORE: 'true'
    ports:
      - ${WEB_PORT}:80
{% if 'kafka' in plugins %}
    extra_hosts:
       - de9-72:192.168.101.72
       - de9-73:192.168.101.73
       - de9-74:192.168.101.74
{% endif %}
    volumes:
      - /usr/share/zoneinfo/Asia/Taipei:/usr/share/zoneinfo/Asia/Taipei
      - /usr/share/zoneinfo/Asia/Taipei:/etc/localtime/
      - /etc/timezone:/etc/timezone
      # 调试代码时，不用每次都重建镜像
      #- .:/var/{{swagger.name}}
      # 支持ngix + uwsgi
      - ./supervisord.conf:/etc/supervisor.d/supervisord.conf
      - ./default.conf:/etc/nginx/conf.d/default.conf
      - ./uwsgi.ini:/var/{{swagger.name}}/uwsgi.ini
    working_dir: /var/{{swagger.name}}
    # command: ["python3","run.py"]
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
