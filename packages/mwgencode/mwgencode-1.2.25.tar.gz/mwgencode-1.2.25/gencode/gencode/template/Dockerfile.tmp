FROM cxhjet/flask-py3.6:1.9
COPY ./requirements.txt /var/requirements.txt
COPY . /var/{{swagger.name}}
WORKDIR /var/{{swagger.name}}
RUN apk add --update --no-cache --virtual  .build-deps \
                make \
                gcc \
                libc-dev \
                jpeg-dev \
                zlib-dev \
                linux-headers \
                python3-dev \
                # 解决 ImageFont.truetype 出错的问题
                freetype \
                freetype-dev \
    && pip install --upgrade pip \
    && pip3 install -r /var/requirements.txt \
    && python /var/{{swagger.name}}/setup.py install \
    && find /var/{{swagger.name}} -depth \
		\( \
		    \( -type d -a -name app -o -name docs -o -name build -o -name .git  -o -name migrations \
		      -o -name .idea -o -name __pycache__ -o -name swagger -o -name seeds -o -name -tests \) \
		    -o \
		    \( -type f -a -name '*.pyc' -o -name '*.pyo'  -o -name '*.c' \
		       -o -name '*.md' -o -name '*.pot' -o -name 'config-sample.ini' \
		       -o -name 'migrate_run.*' -o -name '*.mdj' -o -name '*.sqlite' -o -name '*.yaml' \
		        -o -name 'gen_code_run.py' -o -name 'run.sh'  -o -name 'run-dev.sh' -o -name 'uwsgi-dev.ini' \
		       -o -name 'setup.py' -o -name 'requirements.txt' -o -name 'Dockerfile' -o -name 'Dockerfile_dev' \
		       -o -name 'docker-compose-dev.yaml' \) \
		\) -exec rm -rf '{}' + \
	# 删除APP package 中的源码
	&& find /usr/local/lib/python3.6/site-packages/app -depth \
		\( \
		    \( -type d -a -name __pycache__ \) \
		    -o \
		    \( -type f -a -name '*.pyc' -o -name '*.pyo'  -o -name '*.c' -o -name '*.py' \) \
		\) -exec rm -rf '{}' + \
    && find /usr/local -depth \
		\( \
		    \( -type d -a -name test -o -name tests -o -name __pycache__ \) \
		    -o \
		    \( -type f -a -name '*.pyc' -o -name '*.pyo' \) \
		\) -exec rm -rf '{}' + \
	&& runDeps="$( \
		scanelf --needed --nobanner --recursive /usr/local \
			| awk '{ gsub(/,/, "\nso:", $2); print "so:" $2 }' \
			| sort -u \
			| xargs -r apk info --installed \
			| sort -u \
	)" \
	&& apk add --virtual .python-rundeps $runDeps \
    && apk del .build-deps