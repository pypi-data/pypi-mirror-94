!function(e){"use strict";function t(e){return e.nodeType===Node.ELEMENT_NODE}const n=["A","ABBR","ACRONYM","AUDIO","B","BDI","BDO","BIG","BR","BUTTON","CANVAS","CITE","CODE","DATA","DATALIST","DEL","DFN","EM","EMBED","I","IFRAME","IMG","INPUT","INS","KBD","LABEL","MAP","MARK","METER","NOSCRIPT","OBJECT","OUTPUT","PICTURE","PROGRESS","Q","RUBY","S","SAMP","SCRIPT","SELECT","SLOT","SMALL","SPAN","STRONG","SUB","SUP","SVG","TEMPLATE","TEXTAREA","TIME","U","TT","VAR","VIDEO","WBR"];let i={},o={},s=["P","DIV","BR","SUB","SUP"];for(const e of s)i[e]={attrs:[]};s=["B","BLOCKQUOTE","CODE","DD","DL","DT","EM","H1","H2","H3","I","LI","OL","PRE","RP","RT","RUBY","STRONG","TABLE","U","UL"];for(const e of s)o[e]={attrs:[]};i.IMG={attrs:["SRC"]},o.A={attrs:["HREF"]},o.TR={attrs:["ROWSPAN"]},o.TD={attrs:["COLSPAN","ROWSPAN"]},o.TH={attrs:["COLSPAN","ROWSPAN"]},o.FONT={attrs:["COLOR"]};const r={color:!0,"background-color":!0,"font-weight":!0,"font-style":!0,"text-decoration-line":!0};o.SPAN=function(e){for(const t of[...e.attributes]){"STYLE"!==t.name.toUpperCase()&&e.removeAttributeNode(t)}for(const t of[...e.style]){const n=e.style.getPropertyValue(t);(!r.hasOwnProperty(t)||"background-color"===t&&"transparent"===n||document.body.classList.contains("nightMode")&&("background-color"===t||"color"===t))&&e.style.removeProperty(t)}},Object.assign(o,i);let l=function(e){(function(e){return e instanceof HTMLElement})(e)&&(e.style.removeProperty("background-color"),e.style.removeProperty("font-size"),e.style.removeProperty("font-family"));for(let t=0;t<e.children.length;t++){const n=e.children[t];l(n)}},c=function(e,n){if(!t(e))return;for(const t of[...e.children])c(t,n);if("ANKITOP"===e.tagName)return;const s=n?o[e.tagName]:i[e.tagName];if(s)if("function"==typeof s)s(e);else for(const t of[...e.attributes]){const n=t.name.toUpperCase();-1===s.attrs.indexOf(n)&&e.removeAttributeNode(t)}else e.innerHTML&&"TITLE"!==e.tagName?e.outerHTML=e.innerHTML:e.parentNode.removeChild(e)};function a(e,t){window.bridgeCommand(e,t)}let d=null,u=null,f=null;function h(){T(),u=setTimeout((function(){p(),S("key")}),600)}function m(e){if("Escape"!==e.code){if("Enter"!==e.code||function(){const e=d.getSelection().anchorNode;let n=!1,i=t(e)?e:e.parentElement;for(;i;)n=n||"list-item"==window.getComputedStyle(i).display,i=i.parentElement;return n}()||(e.preventDefault(),document.execCommand("insertLineBreak")),d.isRightToLeft()){const t=d.getSelection(),n=e.ctrlKey?"word":"character",i=e.shiftKey?"extend":"move";switch(e.code){case"ArrowRight":return t.modify(i,"right",n),void e.preventDefault();case"ArrowLeft":return t.modify(i,"left",n),void e.preventDefault()}}h()}else d.blurEditable()}function g(e){if("Enter"===e.code||"Backspace"===e.code){const e=d.getSelection().anchorNode;!t(e)||"DIV"!==e.tagName||e instanceof O||1!==e.childElementCount||"BR"!==e.children[0].tagName||e.replaceWith(e.children[0])}}function E(){h()}function p(){const e=["bold","italic","underline","superscript","subscript"];for(const t of e){document.querySelector(`#${t}`).classList.toggle("highlighted",document.queryCommandState(t))}}function b(e,t,n=!1){document.execCommand(e,!1,t),n||(S("key"),p())}function T(){u&&(clearTimeout(u),u=null)}function L(e){const t=e.currentTarget;if(d===t)return;t.focusEditable(),d=t,a(`focus:${d.ord}`),M(),function(){const e=document.createRange();e.selectNodeContents(d.editable),e.collapse(!1);const t=d.getSelection();t.removeAllRanges(),t.addRange(e)}();const n=function(e){let t=0;do{t+=e.offsetTop,e=e.offsetParent}while(e);return t}(t);(window.pageYOffset+window.innerHeight<n+t.offsetHeight||window.pageYOffset>n)&&window.scroll(0,n+t.offsetHeight-window.innerHeight)}function y(e){a("paste"),e.preventDefault()}function v(){d&&(document.activeElement===d?S("key"):(S("blur"),d=null,R()))}function C(e){if(0===e.childNodes.length)return!1;for(const o of e.children)if(t(i=o)&&!n.includes(i.tagName))return!1;var i;return!0}function S(e){T(),d&&a(`${e}:${d.ord}:${f}:${d.fieldHTML}`)}function A(e,t,n){const i=e.match(/^(\s*)([^]*?)(\s*)$/);return i[1]+t+i[2]+n+i[3]}function R(){$("button.linkb:not(.perm)").prop("disabled",!0)}function M(){$("button.linkb").prop("disabled",!1)}function N(e,t,n){const i=d.getSelection();let o=i.getRangeAt(0);const s=o.cloneContents(),r=document.createElement("span");if(r.appendChild(s),n){b("inserttext",A(r.innerText,e,t))}else{b("inserthtml",A(r.innerHTML,e,t))}r.innerHTML||(o=i.getRangeAt(0),o.setStart(o.startContainer,o.startOffset-t.length),o.collapse(!0),i.removeAllRanges(),i.addRange(o))}function B(){return a("cutOrCopy"),!0}class w extends HTMLElement{set fieldHTML(e){this.innerHTML=e,C(this)&&this.appendChild(document.createElement("br"))}get fieldHTML(){return C(this)&&this.innerHTML.endsWith("<br>")?this.innerHTML.slice(0,-4):this.innerHTML}connectedCallback(){this.setAttribute("contenteditable","")}}customElements.define("anki-editable",w);class O extends HTMLDivElement{constructor(){super(),this.attachShadow({mode:"open"}),this.className="field";const e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("href","./_anki/css/editable.css"),this.shadowRoot.appendChild(e),this.baseStyle=document.createElement("style"),this.baseStyle.setAttribute("rel","stylesheet"),this.shadowRoot.appendChild(this.baseStyle),this.editable=document.createElement("anki-editable"),this.shadowRoot.appendChild(this.editable)}get ord(){return Number(this.getAttribute("ord"))}set fieldHTML(e){this.editable.fieldHTML=e}get fieldHTML(){return this.editable.fieldHTML}connectedCallback(){this.addEventListener("keydown",m),this.addEventListener("keyup",g),this.addEventListener("input",E),this.addEventListener("focus",L),this.addEventListener("blur",v),this.addEventListener("paste",y),this.addEventListener("copy",B),this.addEventListener("oncut",B);this.baseStyle.sheet.insertRule("anki-editable {}",0)}disconnectedCallback(){this.removeEventListener("keydown",m),this.removeEventListener("keyup",g),this.removeEventListener("input",E),this.removeEventListener("focus",L),this.removeEventListener("blur",v),this.removeEventListener("paste",y),this.removeEventListener("copy",B),this.removeEventListener("oncut",B)}initialize(e,t){this.setBaseColor(e),this.editable.fieldHTML=t}setBaseColor(e){this.baseStyle.sheet.cssRules[0].style.color=e}setBaseStyling(e,t,n){const i=this.baseStyle.sheet.cssRules[0];i.style.fontFamily=e,i.style.fontSize=t,i.style.direction=n}isRightToLeft(){return"rtl"===this.editable.style.direction}getSelection(){return this.shadowRoot.getSelection()}focusEditable(){this.editable.focus()}blurEditable(){this.editable.blur()}}customElements.define("anki-editing-area",O,{extends:"div"});class k extends HTMLDivElement{constructor(){super(),this.labelContainer=document.createElement("div"),this.labelContainer.className="fname",this.appendChild(this.labelContainer),this.label=document.createElement("span"),this.label.className="fieldname",this.labelContainer.appendChild(this.label),this.editingArea=document.createElement("div",{is:"anki-editing-area"}),this.appendChild(this.editingArea)}static get observedAttributes(){return["ord"]}set ord(e){this.setAttribute("ord",String(e))}attributeChangedCallback(e,t,n){switch(e){case"ord":this.editingArea.setAttribute("ord",n)}}initialize(e,t,n){this.label.innerText=e,this.editingArea.initialize(t,n)}setBaseStyling(e,t,n){this.editingArea.setBaseStyling(e,t,n)}}function H(e){var t;return null!==(t=document.getElementById("fields").children[e])&&void 0!==t?t:null}function P(e,t){const n=document.getElementById("fields").children;for(let i=0;i<n.length;i++){t(n[i],e[i])}}customElements.define("anki-editor-field",k,{extends:"div"});e.focusField=function(e){const t=H(e);t&&t.editingArea.focusEditable()},e.focusIfField=function(e,t){const n=document.elementsFromPoint(e,t);for(let e=0;e<n.length;e++){let t=n[e];if(t instanceof O)return t.focusEditable(),d=t,!0}return!1},e.forEditorField=P,e.getEditorField=H,e.pasteHTML=function(e,t,n){""!==(e=function(e,t,n){const i=document.createElement("ankitop");i.innerHTML=e,t?l(i):c(i,n);let o=i.innerHTML;return n||t||(o=o.replace(/[\n\t ]+/g," ")),o=o.trim(),o}(e,t,n))&&b("inserthtml",e)},e.preventButtonFocus=function(){for(const e of document.querySelectorAll("button.linkb"))e.addEventListener("mousedown",(e=>{e.preventDefault()}))},e.saveNow=function(e){d&&(T(),e?S("key"):d.blurEditable())},e.setBackgrounds=function(e){P(e,((e,t)=>e.editingArea.classList.toggle("dupe","dupe"===t))),document.querySelector("#dupes").classList.toggle("is-inactive",!e.includes("dupe"))},e.setFGButton=function(e){document.getElementById("forecolor").style.backgroundColor=e},e.setFields=function(e){const t=window.getComputedStyle(document.documentElement).getPropertyValue("--text-fg");!function(e){const t=document.getElementById("fields");for(;t.childElementCount<e;){const e=document.createElement("div",{is:"anki-editor-field"});e.ord=t.childElementCount,t.appendChild(e)}for(;t.childElementCount>e;)t.removeChild(t.lastElementChild)}(e.length),P(e,((e,[n,i])=>e.initialize(n,t,i))),document.activeElement instanceof O?M():R()},e.setFonts=function(e){P(e,((e,[t,n,i])=>{e.setBaseStyling(t,`${n}px`,i?"rtl":"ltr")}))},e.setFormat=b,e.setNoteId=function(e){f=e},e.toggleEditorButton=function(e){$(e)[0].classList.toggle("highlighted")},e.wrap=function(e,t){N(e,t,!1)},e.wrapIntoText=function(e,t){N(e,t,!0)},Object.defineProperty(e,"__esModule",{value:!0})}(this.globalThis=this.globalThis||{});
